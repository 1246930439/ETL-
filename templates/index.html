{% extends "base.html" %}

{% block title %}任务管理 - 任务调度系统{% endblock %}

{% block content %}
<div class="container-fluid compact-layout">
    <!-- 工具栏 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-2 mb-2">
        <div class="btn-toolbar mb-1 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload me-1"></i>上传Python脚本
                </button>
            </div>
        </div>
    </div>

    <!-- 任务表单 -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-light text-dark border-0 py-2">
            <h6 class="card-title mb-0">
                <i class="bi bi-plus-circle me-1"></i>添加/编辑任务
            </h6>
        </div>
        <div class="card-body p-2">
            <form id="task-form" class="mb-0">
                <input type="hidden" id="task-id">
                
                <!-- 第一行：任务名称 -->
                <div class="row g-2 mb-2">
                    <div class="col-md-12">
                        <label for="task-name" class="form-label small">任务名称</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-card-heading text-secondary"></i></span>
                            <input type="text" class="form-control border-start-0" id="task-name" placeholder="请输入任务名称" required>
                        </div>
                    </div>
                </div>
                
                <!-- 第二行：任务类型、脚本选择、Cron表达式 -->
                <div class="row g-2 mb-2">
                    <div class="col-md-2">
                        <label for="task-type" class="form-label small">任务类型</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-gear text-secondary"></i></span>
                            <select class="form-select border-start-0" id="task-type" required>
                                <option value="">选择类型</option>
                                <option value="python">Python脚本</option>
                                <option value="sql">SQL脚本</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-5 python-script-field">
                        <label for="task-python-script" class="form-label small">Python脚本</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-file-earmark-code text-secondary"></i></span>
                            <select class="form-select border-start-0" id="task-python-script">
                                <option value="">请选择Python脚本</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-5 sql-script-field" style="display: none;">
                        <label for="task-sql-script-id" class="form-label small">SQL脚本</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-file-earmark-sql text-secondary"></i></span>
                            <select class="form-select border-start-0" id="task-sql-script-id">
                                <option value="">选择SQL脚本</option>
                                <!-- 动态加载SQL脚本选项 -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label for="task-cron" class="form-label small">Cron表达式</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-clock text-secondary"></i></span>
                            <input type="text" class="form-control border-start-0 border-end-0" id="task-cron" placeholder="例如: 0 0 * * *">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#cronModal">
                                <i class="bi bi-gear"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 第三行：依赖任务、重试配置和按钮 -->
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label for="task-dependencies" class="form-label small">依赖任务</label>
                        <select class="form-select form-select-sm" id="task-dependencies" multiple>
                            <!-- 动态加载任务选项 -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="max-retries" class="form-label small">最大重试</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-arrow-repeat text-secondary"></i></span>
                            <input type="number" class="form-control border-start-0" id="max-retries" placeholder="0" min="0" value="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="retry-delay" class="form-label small">重试间隔(秒)</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="bi bi-clock-history text-secondary"></i></span>
                            <input type="number" class="form-control border-start-0" id="retry-delay" placeholder="60" min="1" value="60">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex gap-1 justify-content-end">
                            <button type="submit" class="btn btn-primary btn-sm" id="task-submit-btn">
                                <i class="bi bi-plus-circle me-1"></i>添加任务
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm d-none" id="task-cancel-btn">
                                <i class="bi bi-x-circle me-1"></i>取消编辑
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 任务列表 -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light text-dark border-0 py-2">
            <h6 class="card-title mb-0">
                <i class="bi bi-list-check me-1"></i>任务列表
            </h6>
        </div>
        <div class="card-body p-2">
            <!-- 筛选表单 -->
            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label for="filter-task-name" class="form-label small">任务名称</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="bi bi-search text-secondary"></i></span>
                        <input type="text" class="form-control border-start-0" id="filter-task-name" placeholder="输入任务名称">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="filter-task-type" class="form-label small">任务类型</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="bi bi-gear text-secondary"></i></span>
                        <select class="form-select border-start-0" id="filter-task-type">
                            <option value="">全部类型</option>
                            <option value="python">Python脚本</option>
                            <option value="sql">SQL脚本</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="filter-is-active" class="form-label small">启用状态</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="bi bi-toggle-on text-secondary"></i></span>
                        <select class="form-select border-start-0" id="filter-is-active">
                            <option value="">全部状态</option>
                            <option value="true">启用</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="filter-latest-status" class="form-label small">执行状态</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="bi bi-activity text-secondary"></i></span>
                        <select class="form-select border-start-0" id="filter-latest-status">
                            <option value="">全部状态</option>
                            <option value="success">成功</option>
                            <option value="failed">失败</option>
                            <option value="none">未执行</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">&nbsp;</label>
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-primary btn-sm" id="filter-btn">
                            <i class="bi bi-funnel me-1"></i>筛选
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="reset-filter-btn">
                            <i class="bi bi-arrow-clockwise me-1"></i>重置
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tasks-table">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>任务名称</th>
                            <th>任务类型</th>
                            <th>脚本路径/SQL脚本</th>
                            <th>Cron表达式</th>
                            <th>上次运行</th>
                            <th>下次运行</th>
                            <th>启用状态</th>
                            <th>执行状态</th>
                            <th class="table-actions">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 动态加载任务数据 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 文件上传模态框 -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>上传Python脚本
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="upload-form">
                    <div class="mb-4">
                        <label for="script-file" class="form-label fw-semibold">选择Python脚本文件</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light"><i class="bi bi-file-earmark-code text-primary"></i></span>
                            <input class="form-control border-start-0" type="file" id="script-file" accept=".py" required>
                        </div>
                        <small class="form-text text-muted">仅支持.py格式的Python脚本文件</small>
                    </div>
                    <div id="upload-result"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>取消
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="$('#upload-form').submit()">
                    <i class="bi bi-upload me-2"></i>上传
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cron表达式配置模态框 -->
<div class="modal fade" id="cronModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light text-dark">
                <h6 class="modal-title">
                    <i class="bi bi-gear me-2"></i>Cron表达式配置
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row">
                    <div class="col-md-5">
                        <h6 class="fw-bold mb-2">
                            <i class="bi bi-lightning-charge me-2 text-secondary"></i>快速选择
                        </h6>
                        <div class="d-grid gap-1">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCronExpression('0 * * * *')">
                                <i class="bi bi-clock me-1"></i>每小时
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCronExpression('0 0 * * *')">
                                <i class="bi bi-calendar-day me-1"></i>每天
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCronExpression('0 0 * * 0')">
                                <i class="bi bi-calendar-week me-1"></i>每周
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCronExpression('0 0 1 * *')">
                                <i class="bi bi-calendar-month me-1"></i>每月
                            </button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h6 class="fw-bold mb-2">
                            <i class="bi bi-sliders me-2 text-secondary"></i>自定义表达式
                        </h6>
                        <form id="cron-form">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">分钟 (0-59)</label>
                                    <input type="text" class="form-control form-control-sm" id="cron-minute" placeholder="*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">小时 (0-23)</label>
                                    <input type="text" class="form-control form-control-sm" id="cron-hour" placeholder="*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">日 (1-31)</label>
                                    <input type="text" class="form-control form-control-sm" id="cron-day" placeholder="*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">月 (1-12)</label>
                                    <input type="text" class="form-control form-control-sm" id="cron-month" placeholder="*">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">周 (0-7, 0和7都表示周日)</label>
                                    <input type="text" class="form-control form-control-sm" id="cron-week" placeholder="*">
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary btn-sm" onclick="generateCronExpression()">
                                    <i class="bi bi-gear me-1"></i>生成表达式
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary btn-sm" onclick="applyCronExpression()">
                    <i class="bi bi-check-circle me-1"></i>应用
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务日志模态框 -->
<div class="modal fade" id="taskLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light text-dark">
                <h6 class="modal-title">
                    <i class="bi bi-file-text me-2"></i>任务执行日志
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <!-- 任务信息 -->
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 fw-bold">
                            <i class="bi bi-info-circle me-2 text-secondary"></i>任务信息
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>任务名称：</strong>
                                <span id="log-task-name" class="text-secondary">-</span>
                            </div>
                            <div class="col-md-6">
                                <strong>执行时间：</strong>
                                <span id="log-execution-time" class="text-secondary">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 执行状态 -->
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 fw-bold">
                            <i class="bi bi-flag me-2 text-secondary"></i>执行状态
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="log-status-container" class="text-center">
                            <!-- 状态将在这里动态显示 -->
                        </div>
                    </div>
                </div>
                
                <!-- 日志内容 -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 fw-bold">
                            <i class="bi bi-journal-text me-2 text-secondary"></i>日志内容
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <pre id="task-log-content" class="bg-dark text-light p-2 rounded" style="max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>关闭
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务执行进度模态框 -->
<div class="modal fade" id="taskRunProgressModal" tabindex="-1" aria-labelledby="taskRunProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light text-dark">
                <h6 class="modal-title" id="taskRunProgressModalLabel">
                    <i class="bi bi-play-circle me-2"></i>任务执行进度
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <!-- 进度条部分 -->
                <div id="taskRunProgress">
                    <div class="mb-3 text-center">
                        <h4 id="taskRunProgressPercentage" class="text-primary mb-2">0%</h4>
                        <p class="text-muted mb-0">正在执行任务，请稍候...</p>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div id="taskRunProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span id="taskRunProgressStatus">准备执行任务...</span>
                        <span id="taskRunProgressTime">已用时: 0秒</span>
                    </div>
                </div>
                
                <!-- 结果部分 -->
                <div id="taskRunResult" style="display: none;">
                    <div id="taskRunResultContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" id="taskRunModalCloseBtn" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>关闭
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // AJAX配置
    $.ajaxSetup({
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true
    });
    
    // 初始化Cron表达式选择器
    initCronSelector();
    
    // 加载数据
    loadTasks();
    loadTaskOptions();
    loadPythonScripts();
    loadSqlScriptOptions(); // 加载SQL脚本选项
    
    // 筛选按钮点击事件
    $('#filter-btn').on('click', function() {
        loadTasks();
    });
    
    // 重置筛选按钮点击事件
    $('#reset-filter-btn').on('click', function() {
        $('#filter-task-name').val('');
        $('#filter-task-type').val('');
        $('#filter-is-active').val('');
        $('#filter-latest-status').val('');
        loadTasks();
    });
    
    // 筛选输入框回车事件
    $('#filter-task-name').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            loadTasks();
        }
    });
    
    // 任务类型切换
    $('#task-type').on('change', function() {
        const taskType = $(this).val();
        if (taskType === 'python') {
            $('.python-script-field').show();
            $('.sql-script-field').hide();
        } else if (taskType === 'sql') {
            $('.python-script-field').hide();
            $('.sql-script-field').show();
        } else {
            $('.python-script-field').hide();
            $('.sql-script-field').hide();
        }
    });
    
    // 任务表单提交
    $('#task-form').on('submit', function(e) {
        e.preventDefault();
        
        const taskId = $('#task-id').val();
        const taskType = $('#task-type').val();
        const cronExpression = $('#task-cron').val();
        
        // 验证Cron表达式格式
        const cronRegex = /^([0-9\*\/,\-]+)\s+([0-9\*\/,\-]+)\s+([0-9\*\/,\-]+)\s+([0-9\*\/,\-]+)\s+([0-9\*\/,\-]+)$/;
        if (!cronRegex.test(cronExpression)) {
            alert('Cron表达式格式不正确，请检查表达式是否符合规范');
            return;
        }
        
        // 获取依赖任务
        const selectedDependencies = $('#task-dependencies').val() || [];
        
        // 获取重试参数
        const maxRetries = parseInt($('#max-retries').val()) || 0;
        const retryDelay = parseInt($('#retry-delay').val()) || 60;
        
        let taskData = {
            name: $('#task-name').val(),
            task_type: taskType,
            dependencies: selectedDependencies.map(id => parseInt(id)),
            max_retries: maxRetries,
            retry_delay: retryDelay,
            cron_expression: cronExpression
        };
        
        if (taskType === 'python') {
            taskData.script_path = $('#task-python-script').val();
        } else if (taskType === 'sql') {
            taskData.sql_script_id = parseInt($('#task-sql-script-id').val());
        }
        
        // 确定是创建还是更新
        const isUpdate = !!taskId;
        const url = isUpdate ? `/api/tasks/${taskId}` : '/api/tasks';
        const method = isUpdate ? 'PUT' : 'POST';
        const successMessage = isUpdate ? '任务更新成功' : '任务创建成功';
        
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(taskData),
            success: function(response) {
                alert(successMessage);
                loadTasks();
                resetTaskForm();
            },
            error: function(xhr) {
                alert((isUpdate ? '更新' : '添加') + '任务失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
            }
        });
    });
    
    // 取消编辑任务
    $('#task-cancel-btn').on('click', function() {
        resetTaskForm();
    });
    
    // 文件上传表单提交
    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData();
        const fileInput = document.getElementById('script-file');
        formData.append('file', fileInput.files[0]);
        
        // 显示上传中提示
        $('#upload-result').html('<div class="alert alert-info">上传中...</div>');
        
        $.ajax({
            url: '/api/upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#upload-result').html('<div class="alert alert-success">' + response.message + '</div>');
                $('#upload-form')[0].reset();
                // 刷新Python脚本列表
                loadPythonScripts();
                // 自动选择新上传的脚本
                setTimeout(function() {
                    $('#task-python-script').val(response.filepath);
                }, 500);
            },
            error: function(xhr) {
                $('#upload-result').html('<div class="alert alert-danger">上传失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误') + '</div>');
            }
        });
    });
});

// 加载任务
function loadTasks() {
    // 获取筛选参数
    const taskName = $('#filter-task-name').val().trim();
    const taskType = $('#filter-task-type').val();
    const isActive = $('#filter-is-active').val();
    const latestStatus = $('#filter-latest-status').val();
    
    // 构建查询参数
    const params = new URLSearchParams();
    if (taskName) params.append('task_name', taskName);
    if (taskType) params.append('task_type', taskType);
    if (isActive) params.append('is_active', isActive);
    if (latestStatus) params.append('latest_status', latestStatus);
    
    const url = '/api/tasks' + (params.toString() ? '?' + params.toString() : '');
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
            const tbody = $('#tasks-table tbody');
            tbody.empty();
            
            response.tasks.forEach(function(task) {
                const statusBadge = task.is_active ? 
                    '<span class="badge bg-success">启用</span>' : 
                    '<span class="badge bg-danger">禁用</span>';
                
                // 执行状态徽章
                let executionStatusBadge = '';
                if (task.latest_status) {
                    if (task.latest_status === 'success') {
                        executionStatusBadge = '<span class="badge bg-success">成功</span>';
                    } else if (task.latest_status === 'failed') {
                        executionStatusBadge = '<span class="badge bg-danger">失败</span>';
                    } else {
                        executionStatusBadge = '<span class="badge bg-secondary">未知</span>';
                    }
                } else {
                    executionStatusBadge = '<span class="badge bg-light text-dark">未执行</span>';
                }
                
                const scriptDisplay = task.task_type === 'python' ? 
                    task.script_path : 
                    (task.sql_script_name || '-');
                
                const row = `
                    <tr>
                        <td>${task.id}</td>
                        <td>${task.name}</td>
                        <td><span class="badge bg-info">${task.task_type}</span></td>
                        <td>${scriptDisplay}</td>
                        <td><code>${task.cron_expression}</code></td>
                        <td>${formatDate(task.last_run)}</td>
                        <td>${formatDate(task.next_run)}</td>
                        <td>${statusBadge}</td>
                        <td>${executionStatusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="editTask(${task.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="runTaskNow(${task.id})">
                                    <i class="bi bi-play"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="viewTaskLog(${task.id})">
                                    <i class="bi bi-file-text"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="toggleTaskStatus(${task.id})">
                                    <i class="bi bi-toggle-${task.is_active ? 'on' : 'off'}"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteTask(${task.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        },
        error: function(xhr) {
            alert('加载任务失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 加载任务选项（用于依赖选择）
function loadTaskOptions() {
    $.ajax({
        url: '/api/tasks',
        method: 'GET',
        success: function(response) {
            const select = $('#task-dependencies');
            select.empty();
            
            response.tasks.forEach(function(task) {
                select.append(`<option value="${task.id}">${task.name}</option>`);
            });
        },
        error: function(xhr) {
            console.error('加载任务选项失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 加载Python脚本选项
function loadPythonScripts(callback) {
    $.ajax({
        url: '/api/python-scripts',
        method: 'GET',
        success: function(scripts) {
            const select = $('#task-python-script');
            select.empty();
            select.append('<option value="">请选择Python脚本</option>');
            
            scripts.forEach(function(script) {
                select.append(`<option value="${script.path}">${script.name}</option>`);
            });
            
            // 如果提供了回调函数，则执行
            if (typeof callback === 'function') {
                callback();
            }
        },
        error: function(xhr) {
            console.error('加载Python脚本失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 加载SQL脚本选项
function loadSqlScriptOptions(callback) {
    $.ajax({
        url: '/api/sql-scripts',
        method: 'GET',
        success: function(response) {
            const select = $('#task-sql-script-id');
            select.empty();
            select.append('<option value="">选择SQL脚本</option>');
            
            response.sql_scripts.forEach(function(script) {
                select.append(`<option value="${script.id}">${script.name}</option>`);
            });
            
            // 如果提供了回调函数，则执行
            if (typeof callback === 'function') {
                callback();
            }
        },
        error: function(xhr) {
            console.error('加载SQL脚本选项失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 编辑任务
function editTask(taskId) {
    $.ajax({
        url: `/api/tasks/${taskId}`,
        method: 'GET',
        success: function(response) {
            const task = response; // 直接使用response，因为API直接返回任务对象
            $('#task-id').val(task.id);
            $('#task-name').val(task.name);
            $('#task-type').val(task.task_type);
            $('#task-cron').val(task.cron_expression);
            $('#max-retries').val(task.max_retries || 0);
            $('#retry-delay').val(task.retry_delay || 60);
            
            // 设置依赖任务
            if (task.dependencies && task.dependencies.length > 0) {
                $('#task-dependencies').val(task.dependencies);
            }
            
            // 根据任务类型显示相应字段
            if (task.task_type === 'python') {
                // 先加载Python脚本列表，然后设置值
                loadPythonScripts(function() {
                    $('#task-python-script').val(task.script_path || '');
                });
                $('#task-python-script').closest('.col-md-5').show();
                $('#task-sql-script-id').closest('.col-md-5').hide();
            } else if (task.task_type === 'sql') {
                // 先加载SQL脚本列表，然后设置值
                loadSqlScriptOptions(function() {
                    $('#task-sql-script-id').val(task.sql_script_id || '');
                });
                $('#task-python-script').closest('.col-md-5').hide();
                $('#task-sql-script-id').closest('.col-md-5').show();
            }
            
            // 更新按钮状态
            $('#task-submit-btn').html('<i class="bi bi-save me-1"></i>更新');
            $('#task-cancel-btn').removeClass('d-none');
            
            // 滚动到表单
            $('html, body').animate({
                scrollTop: $('#task-form').offset().top - 100
            }, 500);
        },
        error: function(xhr) {
            alert('获取任务失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 立即运行任务
function runTaskNow(taskId) {
    // 显示模态框和进度条
    const modal = new bootstrap.Modal(document.getElementById('taskRunProgressModal'));
    modal.show();
    
    // 重置模态框状态
    document.getElementById('taskRunProgress').style.display = 'block';
    document.getElementById('taskRunResult').style.display = 'none';
    
    // 初始化进度条
    let progress = 0;
    const progressBar = document.getElementById('taskRunProgressBar');
    const progressPercentage = document.getElementById('taskRunProgressPercentage');
    const progressStatus = document.getElementById('taskRunProgressStatus');
    const progressTime = document.getElementById('taskRunProgressTime');
    
    // 记录开始时间
    const startTime = Date.now();
    
    // 更新进度和时间
    const progressInterval = setInterval(() => {
        // 更新时间显示
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        progressTime.textContent = `已用时: ${elapsed}秒`;
        
        // 模拟进度增长（根据不同阶段）
        if (progress < 20) {
            progress += 2;
            progressStatus.textContent = '准备执行任务...';
        } else if (progress < 40) {
            progress += 1;
            progressStatus.textContent = '加载任务配置...';
        } else if (progress < 60) {
            progress += 0.8;
            progressStatus.textContent = '执行任务脚本...';
        } else if (progress < 80) {
            progress += 0.5;
            progressStatus.textContent = '处理任务结果...';
        } else if (progress < 95) {
            progress += 0.2;
            progressStatus.textContent = '更新任务状态...';
        } else {
            // 保持在95%，等待实际完成
            progress = Math.min(progress, 95);
            progressStatus.textContent = '即将完成...';
        }
        
        // 更新进度条和百分比
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressPercentage.textContent = `${Math.floor(progress)}%`;
    }, 200);
    
    // 发送执行任务请求
    $.ajax({
        url: `/api/tasks/${taskId}/run`,
        method: 'POST',
        success: function(response) {
            // 清除进度更新
            clearInterval(progressInterval);
            
            // 完成进度条
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', 100);
            progressBar.classList.remove('progress-bar-animated');
            progressPercentage.textContent = '100%';
            progressStatus.textContent = '任务执行完成';
            
            // 显示结果
            setTimeout(() => {
                document.getElementById('taskRunProgress').style.display = 'none';
                document.getElementById('taskRunResult').style.display = 'block';
                
                const resultContent = document.getElementById('taskRunResultContent');
                resultContent.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>任务执行成功</h6>
                        <p class="mb-0">${response.message || '任务已成功执行'}</p>
                    </div>
                `;
                
                // 刷新任务列表
                loadTasks();
            }, 500);
        },
        error: function(xhr) {
            // 清除进度更新
            clearInterval(progressInterval);
            
            // 显示错误
            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
            progressBar.classList.add('bg-danger');
            progressStatus.textContent = '任务执行失败';
            
            // 显示结果
            setTimeout(() => {
                document.getElementById('taskRunProgress').style.display = 'none';
                document.getElementById('taskRunResult').style.display = 'block';
                
                const resultContent = document.getElementById('taskRunResultContent');
                resultContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>任务执行失败</h6>
                        <p class="mb-0">${xhr.responseJSON ? xhr.responseJSON.error : '未知错误'}</p>
                    </div>
                `;
            }, 500);
        }
    });
}

// 查看任务日志
function viewTaskLog(taskId) {
    $.ajax({
        url: `/api/tasks/${taskId}/latest-log`,
        method: 'GET',
        success: function(response) {
            // 检查是否有日志数据（有status字段表示有实际日志）
            if (response.status !== undefined) {
                // 设置任务名称
                $('#log-task-name').text(response.task_name || '未知任务');
                
                // 设置执行时间
                const executionTime = response.execution_time ? 
                    new Date(response.execution_time).toLocaleString('zh-CN') : 
                    '未知时间';
                $('#log-execution-time').text(executionTime);
                
                // 设置执行状态（根据状态显示不同的UI）
                const statusContainer = $('#log-status-container');
                let statusHtml = '';
                
                if (response.status === 'success') {
                    statusHtml = `
                        <div class="alert alert-success d-flex align-items-center justify-content-center" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span class="fw-bold">执行成功</span>
                        </div>
                    `;
                } else if (response.status === 'failed') {
                    statusHtml = `
                        <div class="alert alert-danger d-flex align-items-center justify-content-center" role="alert">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <span class="fw-bold">执行失败</span>
                        </div>
                    `;
                } else if (response.status === 'running') {
                    statusHtml = `
                        <div class="alert alert-info d-flex align-items-center justify-content-center" role="alert">
                            <i class="bi bi-arrow-repeat me-2"></i>
                            <span class="fw-bold">正在执行</span>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div class="alert alert-secondary d-flex align-items-center justify-content-center" role="alert">
                            <i class="bi bi-question-circle me-2"></i>
                            <span class="fw-bold">未知状态: ${response.status}</span>
                        </div>
                    `;
                }
                
                statusContainer.html(statusHtml);
                
                // 设置日志内容
                $('#task-log-content').text(response.message || '无详细日志信息');
            } else {
                // 没有日志数据，显示提示信息
                $('#log-task-name').text(response.task_name || '未知任务');
                $('#log-execution-time').text('-');
                
                const statusContainer = $('#log-status-container');
                statusContainer.html(`
                    <div class="alert alert-warning d-flex align-items-center justify-content-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span class="fw-bold">暂无执行记录</span>
                    </div>
                `);
                
                $('#task-log-content').text(response.message || '该任务暂无执行日志');
            }
            
            $('#taskLogModal').modal('show');
        },
        error: function(xhr) {
            alert('获取任务日志失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : '未知错误'));
        }
    });
}

// 切换任务状态
function toggleTaskStatus(taskId) {
    $.ajax({
        url: `/api/tasks/${taskId}/toggle`,
        method: 'POST',
        success: function(response) {
            alert('任务状态已更新');
            loadTasks();
        },
        error: function(xhr) {
            alert('更新任务状态失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
        }
    });
}

// 删除任务
function deleteTask(taskId) {
    if (confirm('确定要删除此任务吗？')) {
        $.ajax({
            url: `/api/tasks/${taskId}`,
            method: 'DELETE',
            success: function(response) {
                alert('任务删除成功');
                loadTasks();
            },
            error: function(xhr) {
                alert('删除任务失败: ' + (xhr.responseJSON ? xhr.responseJSON.error : '未知错误'));
            }
        });
    }
}

// 重置任务表单
function resetTaskForm() {
    $('#task-form')[0].reset();
    $('#task-id').val(''); // 清空隐藏的ID字段
    $('#task-submit-btn').html('<i class="bi bi-plus-circle me-1"></i>添加');
    $('#task-cancel-btn').addClass('d-none');
    $('#task-python-script').closest('.col-md-5').hide();
    $('#task-sql-script-id').closest('.col-md-5').hide();
}

// 格式化日期
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

// 初始化Cron表达式选择器
function initCronSelector() {
    // 初始化时隐藏脚本相关字段
      $('#task-python-script').closest('.col-md-5').hide();
    $('#task-sql-script-id').closest('.col-md-5').hide();
    
    // 加载SQL脚本选项
    loadSqlScriptOptions();
}

// 设置Cron表达式
function setCronExpression(expression) {
    $('#cron-minute').val(expression.split(' ')[0]);
    $('#cron-hour').val(expression.split(' ')[1]);
    $('#cron-day').val(expression.split(' ')[2]);
    $('#cron-month').val(expression.split(' ')[3]);
    $('#cron-week').val(expression.split(' ')[4]);
}

// 生成Cron表达式
function generateCronExpression() {
    const minute = $('#cron-minute').val() || '*';
    const hour = $('#cron-hour').val() || '*';
    const day = $('#cron-day').val() || '*';
    const month = $('#cron-month').val() || '*';
    const week = $('#cron-week').val() || '*';
    
    const cronExpression = `${minute} ${hour} ${day} ${month} ${week}`;
    alert(`生成的Cron表达式: ${cronExpression}`);
}

// 应用Cron表达式
function applyCronExpression() {
    const minute = $('#cron-minute').val() || '*';
    const hour = $('#cron-hour').val() || '*';
    const day = $('#cron-day').val() || '*';
    const month = $('#cron-month').val() || '*';
    const week = $('#cron-week').val() || '*';
    
    const cronExpression = `${minute} ${hour} ${day} ${month} ${week}`;
    $('#task-cron').val(cronExpression);
    $('#cronModal').modal('hide');
}
</script>
{% endblock %}