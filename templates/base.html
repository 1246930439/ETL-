<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}调度工具平台{% endblock %}</title>
    <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-icons.css') }}">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0 fw-bold text-primary">
                    <i class="bi bi-speedometer2 me-2"></i>调度工具平台
                </h1>
                <p class="text-muted small mb-0">高效的任务调度与管理系统</p>
            </div>
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-1"></i>{{ session['username'] }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="bi bi-key me-2"></i>修改密码
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#tokenManageModal">
                            <i class="bi bi-shield-lock me-2"></i>API Token管理
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout">
                            <i class="bi bi-box-arrow-right me-2"></i>退出登录
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded shadow-sm mb-4">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <div class="navbar-nav">
                        <a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="/">
                            <i class="bi bi-list-check me-1"></i>任务管理
                        </a>
                        <a class="nav-link {% if request.endpoint == 'db_config_page' %}active{% endif %}" href="/db-config">
                            <i class="bi bi-database me-1"></i>数据库配置
                        </a>
                        <a class="nav-link {% if request.endpoint == 'sql_scripts_page' %}active{% endif %}" href="/sql-scripts">
                            <i class="bi bi-file-earmark-sql me-1"></i>SQL脚本
                        </a>
                        <a class="nav-link {% if request.endpoint == 'users_page' %}active{% endif %}" href="/users">
                            <i class="bi bi-people me-1"></i>用户管理
                        </a>
                        <a class="nav-link {% if request.endpoint == 'email_configs' %}active{% endif %}" href="/email-configs">
                            <i class="bi bi-gear me-1"></i>邮件配置管理
                        </a>
                        <a class="nav-link {% if request.endpoint == 'alerts_page' %}active{% endif %}" href="/alerts">
                            <i class="bi bi-bell me-1"></i>预警配置
                        </a>
                        <a class="nav-link {% if request.endpoint == 'notification_logs_page' %}active{% endif %}" href="/notification-logs">
                            <i class="bi bi-file-text me-1"></i>通知日志
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        {% block content %}{% endblock %}
    </div>

    <!-- 通用模态框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">确定要执行此操作吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelButton" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmButton">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light text-dark">
                    <h6 class="modal-title">
                        <i class="bi bi-key me-2"></i>修改密码
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label small">当前密码</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="bi bi-lock"></i></span>
                                <input type="password" class="form-control border-start-0" id="current-password" placeholder="请输入当前密码" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label small">新密码</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                                <input type="password" class="form-control border-start-0" id="new-password" placeholder="请输入新密码" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label small">确认新密码</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control border-start-0" id="confirm-password" placeholder="请再次输入新密码" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="changePassword()">
                        <i class="bi bi-check-circle me-1"></i>修改密码
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Token管理模态框 -->
    <div class="modal fade" id="tokenManageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light text-dark">
                    <h6 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>API Token管理
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <!-- 生成Token表单 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light text-dark py-2">
                            <h6 class="mb-0">生成新Token</h6>
                        </div>
                        <div class="card-body">
                            <form id="generate-token-form">
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <label for="token-name" class="form-label small">Token名称</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light"><i class="bi bi-tag"></i></span>
                                            <input type="text" class="form-control border-start-0" id="token-name" placeholder="请输入Token名称" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="token-days" class="form-label small">有效期(天)</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light"><i class="bi bi-calendar"></i></span>
                                            <input type="number" class="form-control border-start-0" id="token-days" placeholder="有效期" min="1" max="365" value="30" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success btn-sm w-100">
                                            <i class="bi bi-plus-circle me-1"></i>生成Token
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Token列表 -->
                    <div class="card">
                        <div class="card-header bg-light text-dark py-2">
                            <h6 class="mb-0">我的Token列表</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0" id="tokens-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Token</th>
                                            <th>创建时间</th>
                                            <th>最后使用时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 动态加载Token数据 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用提示框 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong class="me-auto">系统提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                操作成功
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // 显示提示消息
        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toastEl.querySelector('.toast-header i');
            
            // 设置消息内容
            toastMessage.textContent = message;
            
            // 根据类型设置图标和颜色
            toastHeader.className = 'bi me-2';
            switch(type) {
                case 'success':
                    toastHeader.classList.add('bi-check-circle-fill', 'text-success');
                    break;
                case 'error':
                    toastHeader.classList.add('bi-exclamation-triangle-fill', 'text-danger');
                    break;
                case 'warning':
                    toastHeader.classList.add('bi-exclamation-triangle-fill', 'text-warning');
                    break;
                default:
                    toastHeader.classList.add('bi-info-circle-fill', 'text-primary');
            }
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        // 确认对话框
        function showConfirm(message, onConfirm, onCancel) {
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmButton = document.getElementById('confirmButton');
            const cancelButton = document.getElementById('cancelButton');
            
            confirmMessage.textContent = message;
            
            // 移除之前的事件监听器
            const newConfirmButton = confirmButton.cloneNode(true);
            const newCancelButton = cancelButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
            
            // 添加新的事件监听器
            newConfirmButton.addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(confirmModal);
                modal.hide();
                if (onConfirm) onConfirm();
            });
            
            newCancelButton.addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(confirmModal);
                modal.hide();
                if (onCancel) onCancel();
            });
            
            const modal = new bootstrap.Modal(confirmModal);
            modal.show();
        }
        
        // 页面加载完成后的通用初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有工具提示
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // 监听Token管理模态框打开事件
            document.getElementById('tokenManageModal').addEventListener('show.bs.modal', function () {
                loadTokens();
            });
            
            // 生成Token表单提交事件
            document.getElementById('generate-token-form').addEventListener('submit', function(e) {
                e.preventDefault();
                generateNewToken();
            });
        });
        
        // 修改密码功能
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // 验证输入
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('请填写所有字段', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('两次输入的新密码不一致', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('新密码长度不能少于6位', 'warning');
                return;
            }
            
            // 发送请求
            $.ajax({
                url: '/api/users/change-password',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                }),
                success: function(response) {
                    showToast('密码修改成功', 'success');
                    // 关闭模态框并清空表单
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    document.getElementById('change-password-form').reset();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : '修改密码失败';
                    showToast(error, 'error');
                }
            });
        }
        
        // 加载Token列表
        function loadTokens() {
            $.get('/api/users/tokens', function(tokens) {
                const tbody = $('#tokens-table tbody');
                tbody.empty();
                
                if (!tokens || tokens.length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    暂无Token
                                </div>
                            </td>
                        </tr>
                    `);
                    return;
                }
                
                tokens.forEach(function(token) {
                    const tokenId = 'token-' + token.id;
                    const maskedToken = token.token.substring(0, 8) + '...' + token.token.substring(token.token.length - 4);
                    tbody.append(`
                        <tr>
                            <td>
                                <code id="${tokenId}">${maskedToken}</code>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToken('${token.token}')" title="复制">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="toggleTokenVisibility('${tokenId}', '${token.token}')" title="显示/隐藏Token">
                                    <i class="bi bi-eye" id="${tokenId}-icon"></i>
                                </button>
                            </td>
                            <td>${formatDateTime(token.created_at)}</td>
                            <td>${token.last_used ? formatDateTime(token.last_used) : '未使用'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteToken(${token.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }).fail(function() {
                showToast('加载Token列表失败', 'error');
            });
        }
        
        // 生成新Token
        function generateNewToken() {
            const tokenName = document.getElementById('token-name').value;
            const tokenDays = document.getElementById('token-days').value || 30;
            
            if (!tokenName) {
                showToast('请输入Token名称', 'warning');
                return;
            }
            
            $.ajax({
                url: '/api/users/generate-token',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    name: tokenName,
                    days: parseInt(tokenDays)
                }),
                success: function(response) {
                    showToast('Token生成成功', 'success');
                    // 清空表单
                    document.getElementById('token-name').value = '';
                    document.getElementById('token-days').value = '30';
                    // 重新加载Token列表
                    loadTokens();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : '生成Token失败';
                    showToast(error, 'error');
                }
            });
        }
        
        // 删除Token
        function deleteToken(tokenId) {
            // 直接显示确认对话框，不关闭Token管理模态框
            showConfirm('确定要删除此Token吗？', function() {
                $.ajax({
                    url: '/api/users/tokens/' + tokenId,
                    type: 'DELETE',
                    success: function() {
                        showToast('Token删除成功', 'success');
                        // 刷新Token列表
                        loadTokens();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON ? xhr.responseJSON.error : '删除Token失败';
                        showToast(error, 'error');
                    }
                });
            });
        }
        
        // 复制Token到剪贴板
        function copyToken(token) {
            navigator.clipboard.writeText(token).then(function() {
                showToast('Token已复制到剪贴板', 'success');
            }).catch(function() {
                showToast('复制失败，请手动复制', 'error');
            });
        }
        
        // 切换Token显示/隐藏状态
        function toggleTokenVisibility(tokenId, fullToken) {
            const tokenElement = document.getElementById(tokenId);
            const iconElement = document.getElementById(tokenId + '-icon');
            
            if (tokenElement.textContent === fullToken) {
                // 当前显示完整Token，切换为部分隐藏
                const maskedToken = fullToken.substring(0, 8) + '...' + fullToken.substring(fullToken.length - 4);
                tokenElement.textContent = maskedToken;
                iconElement.className = 'bi bi-eye';
            } else {
                // 当前显示部分Token，切换为完整显示
                tokenElement.textContent = fullToken;
                iconElement.className = 'bi bi-eye-slash';
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>