{% extends "base.html" %}

{% block title %}邮件配置管理 - 任务调度系统{% endblock %}

{% block extra_css %}
<style>
    .config-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease-in-out;
    }
    .config-item:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .config-item.default {
        border-left: 4px solid #198754;
        background-color: #f8f9fa;
    }
    .config-name {
        font-weight: 600;
        font-size: 1.1rem;
    }
    .config-details {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 工具栏 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addEmailConfigModal">
                    <i class="bi bi-plus-circle me-1"></i>添加配置
                </button>
            </div>
        </div>
    </div>

    <!-- 邮件配置列表 -->
    <div class="row" id="emailConfigsList">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    </div>
</div>

<!-- 添加邮件配置模态框 -->
<div class="modal fade" id="addEmailConfigModal" tabindex="-1" aria-labelledby="addEmailConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmailConfigModalLabel">添加邮件配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEmailConfigForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="configName" class="form-label">配置名称</label>
                            <input type="text" class="form-control" id="configName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mailServer" class="form-label">SMTP服务器</label>
                            <input type="text" class="form-control" id="mailServer" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mailPort" class="form-label">端口</label>
                            <input type="number" class="form-control" id="mailPort" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mailUseTLS" class="form-label">加密方式</label>
                            <select class="form-select" id="mailUseTLS" required>
                                <option value="1">TLS</option>
                                <option value="0">SSL</option>
                                <option value="2">无加密</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mailUsername" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="mailUsername" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mailPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="mailPassword" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mailDefaultSender" class="form-label">默认发件人</label>
                            <input type="email" class="form-control" id="mailDefaultSender">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="isDefault" class="form-label">设为默认</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="isDefault">
                                <label class="form-check-label" for="isDefault">
                                    设为默认邮件配置
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEmailConfig()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑邮件配置模态框 -->
<div class="modal fade" id="editEmailConfigModal" tabindex="-1" aria-labelledby="editEmailConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmailConfigModalLabel">编辑邮件配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmailConfigForm">
                    <input type="hidden" id="editConfigId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editConfigName" class="form-label">配置名称</label>
                            <input type="text" class="form-control" id="editConfigName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editMailServer" class="form-label">SMTP服务器</label>
                            <input type="text" class="form-control" id="editMailServer" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editMailPort" class="form-label">端口</label>
                            <input type="number" class="form-control" id="editMailPort" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editMailUseTLS" class="form-label">加密方式</label>
                            <select class="form-select" id="editMailUseTLS" required>
                                <option value="1">TLS</option>
                                <option value="0">SSL</option>
                                <option value="2">无加密</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editMailUsername" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="editMailUsername" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editMailPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="editMailPassword" placeholder="留空表示不修改">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editMailDefaultSender" class="form-label">默认发件人</label>
                            <input type="email" class="form-control" id="editMailDefaultSender">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editIsDefault" class="form-label">设为默认</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="editIsDefault">
                                <label class="form-check-label" for="editIsDefault">
                                    设为默认邮件配置
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateEmailConfig()">更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 测试邮件模态框 -->
<div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testEmailModalLabel">发送测试邮件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="testEmailForm">
                    <div class="mb-3">
                        <label for="testRecipient" class="form-label">收件人邮箱</label>
                        <input type="email" class="form-control" id="testRecipient" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="sendTestEmail()">发送测试邮件</button>
            </div>
        </div>
    </div>
</div>

<!-- 测试邮件进度和结果模态框 -->
<div class="modal fade" id="testEmailProgressModal" tabindex="-1" aria-labelledby="testEmailProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testEmailProgressModalLabel">发送测试邮件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 进度条部分 -->
                <div id="testEmailProgress">
                    <div class="mb-3 text-center">
                        <h4 id="progressPercentage" class="text-primary mb-2">0%</h4>
                        <p class="text-muted mb-0">正在发送测试邮件，请稍候...</p>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span id="progressStatus">准备连接服务器...</span>
                        <span id="progressTime">已用时: 0秒</span>
                    </div>
                </div>
                
                <!-- 结果部分 -->
                <div id="testEmailResult" style="display: none;">
                    <div id="testEmailResultContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="testEmailModalCloseBtn" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 配置AJAX以包含凭据
$.ajaxSetup({
    xhrFields: {
        withCredentials: true
    },
    crossDomain: true
});

// 当前测试的邮件配置ID
var currentTestConfigId = null;

// 页面加载时执行
$(document).ready(function() {
    loadEmailConfigs();
});

// 加载邮件配置列表
function loadEmailConfigs() {
    $.get('/api/email-configs', function(data) {
        let html = '';
        
        if (data.length === 0) {
            html = '<div class="col-12"><div class="alert alert-info text-center">暂无邮件配置，请添加配置</div></div>';
        } else {
            data.forEach(config => {
                const isDefault = config.is_default == 1;
                const defaultBadge = isDefault ? '<span class="badge bg-success">默认</span>' : '';
                const defaultClass = isDefault ? 'default' : '';
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="config-item ${defaultClass}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="config-name">${config.config_name} ${defaultBadge}</div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton${config.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                        操作
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton${config.id}">
                                        <li><a class="dropdown-item" href="#" onclick="editEmailConfig(${config.id})"><i class="bi bi-pencil me-1"></i>编辑</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="testEmailConfig(${config.id})"><i class="bi bi-envelope me-1"></i>测试</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteEmailConfig(${config.id})"><i class="bi bi-trash me-1"></i>删除</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="config-details">
                                <div class="mb-1"><i class="bi bi-server me-1"></i> ${config.mail_server}:${config.mail_port}</div>
                                <div class="mb-1"><i class="bi bi-person me-1"></i> ${config.mail_username}</div>
                                ${config.mail_default_sender ? `<div class="mb-1"><i class="bi bi-envelope me-1"></i> ${config.mail_default_sender}</div>` : ''}
                                <div class="mb-1"><i class="bi bi-shield me-1"></i> ${config.mail_use_tls == 1 ? 'TLS' : (config.mail_use_tls == 0 ? 'SSL' : '无加密')}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        $('#emailConfigsList').html(html);
    })
    .fail(function() {
        $('#emailConfigsList').html('<div class="col-12"><div class="alert alert-danger text-center">加载邮件配置失败，请刷新页面重试</div></div>');
    });
}

// 保存邮件配置
function saveEmailConfig() {
    const name = $('#configName').val();
    const mailServer = $('#mailServer').val();
    const mailPort = $('#mailPort').val();
    const mailUseTLS = $('#mailUseTLS').val();
    const mailUsername = $('#mailUsername').val();
    const mailPassword = $('#mailPassword').val();
    const mailDefaultSender = $('#mailDefaultSender').val();
    const isDefault = $('#isDefault').is(':checked');

    if (!name || !mailServer || !mailPort || !mailUsername || !mailPassword) {
        alert('请填写完整信息');
        return;
    }

    $.ajax({
        url: '/api/email-configs',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            config_name: name,
            mail_server: mailServer,
            mail_port: parseInt(mailPort),
            mail_use_tls: parseInt(mailUseTLS),
            mail_username: mailUsername,
            mail_password: mailPassword,
            mail_default_sender: mailDefaultSender,
            is_default: isDefault ? 1 : 0
        }),
        success: function() {
            $('#addEmailConfigModal').modal('hide');
            document.getElementById('addEmailConfigForm').reset();
            loadEmailConfigs();
        },
        error: function() {
            alert('保存失败');
        }
    });
}

// 编辑邮件配置
function editEmailConfig(id) {
    $.get(`/api/email-configs/${id}`, function(config) {
        $('#editConfigId').val(config.id);
        $('#editConfigName').val(config.config_name);
        $('#editMailServer').val(config.mail_server);
        $('#editMailPort').val(config.mail_port);
        
        // 设置加密方式：true=TLS(1), false=SSL(0), 2=无加密
        if (config.mail_use_tls === true) {
            $('#editMailUseTLS').val('1');
        } else if (config.mail_use_tls === false) {
            $('#editMailUseTLS').val('0');
        } else {
            $('#editMailUseTLS').val('2');
        }
        
        $('#editMailUsername').val(config.mail_username);
        $('#editMailDefaultSender').val(config.mail_default_sender);
        $('#editIsDefault').prop('checked', config.is_default);
        
        $('#editEmailConfigModal').modal('show');
    });
}

// 更新邮件配置
function updateEmailConfig() {
    const id = $('#editConfigId').val();
    const name = $('#editConfigName').val();
    const mailServer = $('#editMailServer').val();
    const mailPort = $('#editMailPort').val();
    const mailUseTLS = $('#editMailUseTLS').val();
    const mailUsername = $('#editMailUsername').val();
    const mailPassword = $('#editMailPassword').val();
    const mailDefaultSender = $('#editMailDefaultSender').val();
    const isDefault = $('#editIsDefault').is(':checked');

    if (!name || !mailServer || !mailPort || !mailUsername) {
        alert('请填写完整信息');
        return;
    }

    const updateData = {
        config_name: name,
        mail_server: mailServer,
        mail_port: parseInt(mailPort),
        mail_use_tls: parseInt(mailUseTLS),
        mail_username: mailUsername,
        mail_default_sender: mailDefaultSender,
        is_default: isDefault ? 1 : 0
    };

    // 只有当密码不为空时才更新密码
    if (mailPassword) {
        updateData.mail_password = mailPassword;
    }

    $.ajax({
        url: `/api/email-configs/${id}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        success: function() {
            $('#editEmailConfigModal').modal('hide');
            loadEmailConfigs();
        },
        error: function() {
            alert('更新失败');
        }
    });
}

// 删除邮件配置
function deleteEmailConfig(id) {
    if (confirm('确定要删除此邮件配置吗？')) {
        $.ajax({
            url: `/api/email-configs/${id}`,
            type: 'DELETE',
            success: function() {
                loadEmailConfigs();
            },
            error: function() {
                alert('删除失败');
            }
        });
    }
}

// 测试邮件配置
function testEmailConfig(id) {
    currentTestConfigId = id;
    $('#testEmailModal').modal('show');
}

// 发送测试邮件
function sendTestEmail() {
    const recipient = $('#testRecipient').val();
    
    if (!recipient) {
        alert('请输入收件人邮箱');
        return;
    }

    // 关闭输入模态框
    $('#testEmailModal').modal('hide');
    
    // 显示进度模态框
    const progressModal = new bootstrap.Modal(document.getElementById('testEmailProgressModal'));
    progressModal.show();
    
    // 重置进度条
    resetProgressBar();
    
    // 记录开始时间
    const startTime = Date.now();
    
    // 更新进度和时间
    const progressInterval = setInterval(() => {
        // 更新时间显示
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        $('#progressTime').text(`已用时: ${elapsed}秒`);
        
        // 模拟进度增长
        const progress = getSimulatedProgress();
        updateProgressBar(progress, getProgressStatus(progress));
    }, 100);
    
    // 发送测试邮件请求
    $.ajax({
        url: `/api/email-configs/${currentTestConfigId}/test`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            recipient: recipient
        }),
        success: function(data) {
            // 清除进度更新定时器
            clearInterval(progressInterval);
            
            // 完成进度条
            updateProgressBar(100, '发送完成');
            
            // 显示结果
            setTimeout(() => {
                showTestEmailResult(true, data.message);
            }, 500);
        },
        error: function(xhr) {
            // 清除进度更新定时器
            clearInterval(progressInterval);
            
            // 显示错误结果
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : '发送失败';
            showTestEmailResult(false, errorMessage);
        }
    });
}

// 重置进度条
function resetProgressBar() {
    $('#testEmailProgress').show();
    $('#testEmailResult').hide();
    $('#progressBar').css('width', '0%').attr('aria-valuenow', 0);
    $('#progressPercentage').text('0%');
    $('#progressStatus').text('准备连接服务器...');
    $('#progressTime').text('已用时: 0秒');
}

// 更新进度条
function updateProgressBar(progress, status) {
    $('#progressBar').css('width', `${progress}%`).attr('aria-valuenow', progress);
    $('#progressPercentage').text(`${Math.floor(progress)}%`);
    $('#progressStatus').text(status);
}

// 获取模拟进度值
function getSimulatedProgress() {
    const currentProgress = parseInt($('#progressBar').attr('aria-valuenow'));
    
    if (currentProgress < 20) {
        return Math.min(currentProgress + 2, 20);
    } else if (currentProgress < 50) {
        return Math.min(currentProgress + 1, 50);
    } else if (currentProgress < 80) {
        return Math.min(currentProgress + 0.5, 80);
    } else if (currentProgress < 95) {
        return Math.min(currentProgress + 0.2, 95);
    } else {
        // 保持在95%，等待实际完成
        return currentProgress;
    }
}

// 获取进度状态文本
function getProgressStatus(progress) {
    if (progress < 20) {
        return '准备连接服务器...';
    } else if (progress < 40) {
        return '验证配置信息...';
    } else if (progress < 60) {
        return '连接SMTP服务器...';
    } else if (progress < 80) {
        return '发送邮件...';
    } else if (progress < 95) {
        return '等待服务器响应...';
    } else {
        return '即将完成...';
    }
}

// 显示测试邮件结果
function showTestEmailResult(success, message) {
    $('#testEmailProgress').hide();
    $('#testEmailResult').show();
    
    let resultHtml = '';
    if (success) {
        resultHtml = `
            <div class="alert alert-success">
                <h5 class="alert-heading"><i class="bi bi-check-circle me-2"></i>测试邮件发送成功</h5>
                <hr>
                <p class="mb-0">${message}</p>
            </div>
        `;
    } else {
        resultHtml = `
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>测试邮件发送失败</h5>
                <hr>
                <p class="mb-0">${message}</p>
            </div>
        `;
    }
    
    $('#testEmailResultContent').html(resultHtml);
}

</script>
{% endblock %}