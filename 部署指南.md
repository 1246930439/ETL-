# 调度工具平台V1.0 云服务器部署指南

## 项目概述

调度工具平台V1.0是一个基于Flask的Web应用，提供数据库监控、SQL脚本执行、定时任务调度和邮件通知等功能。

## 系统要求

- 操作系统：Linux (推荐Ubuntu 20.04+)
- Python版本：Python 3.8+
- 内存：至少2GB RAM
- 磁盘空间：至少5GB可用空间
- 网络：稳定的互联网连接

## 部署步骤

### 1. 服务器准备

#### 1.1 更新系统
```bash
sudo apt update && sudo apt upgrade -y
```

#### 1.2 配置软件源（可选，解决软件包下载问题）
如果遇到软件包下载失败（如404错误），可以配置官方软件源：

```bash
# 备份原有软件源
sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup

# 配置官方软件源（根据您的Ubuntu版本选择）
# Ubuntu 22.04 LTS (Jammy)
cat << EOF | sudo tee /etc/apt/sources.list
deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
EOF

# 更新软件源
sudo apt update
```

#### 1.3 安装必要的系统依赖
```bash
sudo apt install -y python3 python3-pip python3-venv git nginx supervisor
```

如果安装过程中遇到错误，可以尝试以下解决方法：

```bash
# 方法1：修复可能的依赖问题
sudo apt --fix-missing install

# 方法2：清理软件包缓存
sudo apt clean
sudo apt autoclean
sudo apt autoremove

# 方法3：重新更新软件源
sudo apt update

# 方法4：单独安装有问题的软件包
sudo apt install -y python3-venv --fix-missing
```

#### 1.4 验证系统依赖安装

项目中提供了系统依赖检查脚本 `check_system_deps.sh`，用于验证所有必要的系统依赖是否已正确安装：

```bash
# 上传检查脚本到服务器
scp check_system_deps.sh user@server:/tmp/

# 在服务器上执行检查
chmod +x /tmp/check_system_deps.sh
sudo /tmp/check_system_deps.sh
```

检查脚本会验证以下内容：
- 基本命令是否可用（python3, pip3, git, nginx, supervisorctl）
- 相关软件包是否已安装
- Python venv模块是否可用
- 服务状态（Nginx和Supervisor）
- 目录和权限
- 网络连接状态
- 系统资源使用情况

如果检查脚本显示所有项目都是 [✓] 绿色勾号，则表示系统依赖已正确安装。如果有 [✗] 红色叉号，请根据提示安装缺失的依赖。

### 2. 项目部署

#### 2.1 创建项目目录
```bash
sudo mkdir -p /var/www/scheduler
sudo chown -R $USER:$USER /var/www/scheduler
cd /var/www/scheduler
```

#### 2.2 上传项目文件

**必须上传的核心文件列表：**

1. **Python应用文件**
   - `web_scheduler.py` - 主应用文件
   - `start_server.py` - 服务器启动脚本

2. **依赖文件**
   - `requirements.txt` - Python依赖包列表

3. **模板文件** (templates目录)
   - `templates/base.html` - 基础模板
   - `templates/login.html` - 登录页面
   - `templates/index.html` - 主页面
   - `templates/alerts.html` - 告警页面
   - `templates/notification_logs.html` - 通知日志页面
   - `templates/users.html` - 用户管理页面
   - `templates/db_config.html` - 数据库配置页面
   - `templates/email_configs.html` - 邮件配置页面
   - `templates/sql_scripts.html` - SQL脚本页面

4. **静态文件** (static目录)
   - `static/style.css` - 自定义样式文件
   - `static/bootstrap.min.css` - Bootstrap 5.3.0 CSS框架
   - `static/bootstrap-icons.css` - Bootstrap Icons图标库
   - `static/fonts/bootstrap-icons.woff` - Bootstrap Icons字体文件
   - `static/fonts/bootstrap-icons.woff2` - Bootstrap Icons字体文件(woff2格式)

5. **工具脚本** (可选)
   - `uploads/excel_to_db.py` - Excel导入数据库工具
   - `excel_to_db/excel_to_db.py` - Excel导入工具主文件
   - `excel_to_db/README.md` - Excel工具说明文档

6. **文档文件** (可选)
   - `部署指南.md` - 本部署文档
   - `project_overview.md` - 项目概述
   - `postman_api_guide.md` - API测试指南

**不需要上传的文件：**
- `.venv/` - Python虚拟环境目录
- `__pycache__/` - Python缓存目录
- `.idea/` - IDE配置目录
- `scheduler.db` - 本地SQLite数据库
- `scheduler.log` - 本地日志文件
- `flask_session/` - Flask会话文件
- `cookie.txt` - Cookie文件
- `start_server.bat` 和 `start_server.ps1` - Windows启动脚本

将项目文件上传到服务器，可以使用以下任一方式：

**方式一：使用git（如果项目已上传到git仓库）**
```bash
git clone [项目仓库地址] .
```

**方式二：使用scp（从本地上传）**
```bash
# 在本地执行，上传所有必要文件
scp -r /path/to/project/web_scheduler.py user@server:/var/www/scheduler/
scp -r /path/to/project/start_server.py user@server:/var/www/scheduler/
scp -r /path/to/project/requirements.txt user@server:/var/www/scheduler/
scp -r /path/to/project/templates user@server:/var/www/scheduler/
scp -r /path/to/project/static user@server:/var/www/scheduler/
scp -r /path/to/project/uploads user@server:/var/www/scheduler/
scp -r /path/to/project/excel_to_db user@server:/var/www/scheduler/
```

**方式三：使用rsync（推荐，支持增量同步）**
```bash
# 在本地执行，排除不需要的文件
rsync -av --exclude='.venv' --exclude='__pycache__' --exclude='.idea' \
  --exclude='*.db' --exclude='*.log' --exclude='flask_session' \
  --exclude='cookie.txt' --exclude='*.bat' --exclude='*.ps1' \
  /path/to/project/ user@server:/var/www/scheduler/
```

#### 2.3 创建Python虚拟环境
```bash
python3 -m venv venv
source venv/bin/activate
```

#### 2.4 安装Python依赖
```bash
pip install -r requirements.txt
```

#### 2.5 静态文件说明

本项目已将Bootstrap和Bootstrap Icons文件下载到本地，而不是使用CDN链接，这样做有以下优势：

1. **稳定性更好**：不依赖外部网络，避免CDN服务不稳定或被墙的问题
2. **安全性更高**：避免CDN被攻击导致的安全风险
3. **加载速度可预测**：不受外部CDN速度影响，特别适合内网环境
4. **离线可用**：完全不依赖外部网络，适合网络不稳定的环境

本地化的静态文件包括：
- `static/bootstrap.min.css` - Bootstrap 5.3.0 CSS框架
- `static/bootstrap-icons.css` - Bootstrap Icons图标库
- `static/fonts/bootstrap-icons.woff` - Bootstrap Icons字体文件
- `static/fonts/bootstrap-icons.woff2` - Bootstrap Icons字体文件(woff2格式)

### 3. 数据库配置

#### 3.1 安装数据库（根据需要选择）

**MySQL/MariaDB安装**
```bash
sudo apt install -y mysql-server
sudo mysql_secure_installation
```

**PostgreSQL安装**
```bash
sudo apt install -y postgresql postgresql-contrib
sudo -u postgres psql
```

#### 3.2 创建数据库和用户

##### 3.2.1 SQLite数据库创建

本项目使用SQLite作为默认数据库，数据库文件会在应用首次启动时自动创建。数据库初始化过程包括：

1. **自动创建数据库文件**
   - 数据库文件名：`scheduler.db`
   - 位置：项目根目录下
   - 创建时机：应用首次启动时（通过`init_db()`函数）

2. **数据库表结构**
   应用会自动创建以下表：
   - `tasks` - 任务表（存储Python脚本和SQL脚本任务）
   - `db_configs` - 数据库配置表
   - `sql_scripts` - SQL脚本表
   - `users` - 用户表
   - `user_tokens` - 用户API令牌表
   - `task_logs` - 任务执行日志表
   - `email_configs` - 邮件配置表
   - `task_alerts` - 任务预警表
   - `notification_logs` - 通知日志表
   - `sql_alerts` - SQL预警表
   - `sql_alert_logs` - SQL预警日志表

3. **创建数据库目录**
   ```bash
   # 确保数据库目录存在且有写权限
   sudo mkdir -p /var/www/scheduler
   sudo chown -R www-data:www-data /var/www/scheduler
   sudo chmod -R 755 /var/www/scheduler
   ```

##### 3.2.2 创建默认管理员用户

**通过应用启动自动创建（推荐）**

1. 启动应用，默认管理员将自动创建
   - 用户名：admin
   - 密码：admin123（首次登录后请立即修改）

2. 应用启动时会自动检查是否存在用户，如果没有则创建默认管理员

**手动创建管理员用户（备选方法）**

如果需要手动创建管理员用户，可以使用以下Python脚本：

**方法二：手动创建管理员用户**

1. 创建`create_admin.py`脚本：
   ```python
   #!/usr/bin/env python3
   import sqlite3
   from werkzeug.security import generate_password_hash
   from datetime import datetime
   
   # 数据库路径
   DB_PATH = 'scheduler.db'
   
   # 创建管理员用户
   username = input("请输入管理员用户名: ")
   password = input("请输入管理员密码: ")
   
   # 生成密码哈希
   password_hash = generate_password_hash(password)
   created_at = datetime.now().isoformat()
   
   # 连接数据库
   conn = sqlite3.connect(DB_PATH)
   cursor = conn.cursor()
   
   try:
       cursor.execute('''
           INSERT INTO users (username, password_hash, created_at)
           VALUES (?, ?, ?)
       ''', (username, password_hash, created_at))
       
       conn.commit()
       print(f"管理员用户 {username} 创建成功!")
   except sqlite3.IntegrityError:
       print(f"错误: 用户名 {username} 已存在!")
   finally:
       conn.close()
   ```

2. 运行脚本创建管理员：
   ```bash
   cd /var/www/scheduler
   source venv/bin/activate
   python create_admin.py
   ```

**方法三：通过API创建用户**

1. 启动应用后，使用API创建用户：
   ```bash
   curl -X POST http://localhost:5000/api/users/create \
     -H "Content-Type: application/json" \
     -d '{
       "username": "admin",
       "password": "your_secure_password"
     }'
   ```

##### 3.2.3 数据库备份策略

1. **创建备份目录**
   ```bash
   sudo mkdir -p /var/backups/scheduler
   sudo chown -R www-data:www-data /var/backups/scheduler
   ```

2. **创建备份脚本**
   创建`/var/www/scheduler/backup_db.sh`：
   ```bash
   #!/bin/bash
   BACKUP_DIR="/var/backups/scheduler"
   DB_PATH="/var/www/scheduler/scheduler.db"
   DATE=$(date +%Y%m%d_%H%M%S)
   BACKUP_FILE="$BACKUP_DIR/scheduler_$DATE.db"
   
   # 创建备份
   cp $DB_PATH $BACKUP_FILE
   
   # 保留最近30天的备份
   find $BACKUP_DIR -name "scheduler_*.db" -mtime +30 -delete
   
   echo "Database backed up to $BACKUP_FILE"
   ```

3. **设置定时备份**
   ```bash
   # 添加到crontab，每天凌晨2点备份
   echo "0 2 * * * /var/www/scheduler/backup_db.sh" | crontab -
   ```

##### 3.2.4 数据库迁移（如果从旧版本升级）

如果您有旧版本的数据库需要迁移：

1. **备份旧数据库**
   ```bash
   cp scheduler.db scheduler_backup.db
   ```

2. **运行应用自动迁移**
   - 应用启动时会自动检测并执行必要的数据库结构更新
   - 旧数据会被保留并迁移到新表结构

3. **验证迁移结果**
   ```bash
   sqlite3 scheduler.db ".tables"
   sqlite3 scheduler.db "SELECT COUNT(*) FROM users;"
   ```

### 4. 应用配置

#### 4.1 修改应用配置
编辑 `web_scheduler.py` 文件，确保以下配置正确：

1. 数据库连接配置
2. 邮件服务器配置
3. 主机地址配置（将host从'127.0.0.1'改为'0.0.0.0'以允许外部访问）

#### 4.2 创建日志目录
```bash
sudo mkdir -p /var/log/scheduler
sudo chown -R $USER:$USER /var/log/scheduler
```

### 5. 使用Gunicorn作为WSGI服务器

#### 5.1 安装Gunicorn
```bash
pip install gunicorn
```

#### 5.2 部署Gunicorn配置文件

项目中已提供完整的Gunicorn配置文件 `gunicorn.conf.py`，部署时只需复制并微调：

```bash
# 复制配置文件到项目目录
cp gunicorn.conf.py /var/www/scheduler/

# 根据服务器配置调整工作进程数（通常为CPU核心数*2+1）
# 编辑 /var/www/scheduler/gunicorn.conf.py，修改 workers 参数
```

配置文件主要参数说明：
- `bind = "127.0.0.1:8000"` - 绑定地址和端口
- `workers = 4` - 工作进程数（可根据服务器配置调整）
- `logfile = "/var/log/scheduler/gunicorn.log"` - 日志文件路径
- `user = "www-data"` - 运行用户

### 6. 配置Nginx反向代理

#### 6.1 部署Nginx配置文件

项目中已提供完整的Nginx配置文件 `scheduler_nginx.conf`，部署时只需复制并修改域名：

```bash
# 复制配置文件到Nginx站点目录
sudo cp scheduler_nginx.conf /etc/nginx/sites-available/scheduler

# 修改配置中的域名或IP地址
sudo sed -i 's/your_domain.com/您的域名或IP地址/g' /etc/nginx/sites-available/scheduler

# 启用站点
sudo ln -s /etc/nginx/sites-available/scheduler /etc/nginx/sites-enabled/

# 测试Nginx配置
sudo nginx -t

# 重启Nginx服务
sudo systemctl restart nginx
```

配置文件主要功能：
- 反向代理到Gunicorn服务器（127.0.0.1:8000）
- 静态文件处理和缓存
- Gzip压缩
- 安全设置（HTTPS、CSP等）
- 文件上传大小限制（50MB）

#### 6.2 启用站点
```bash
sudo ln -s /etc/nginx/sites-available/scheduler /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 7. 配置Supervisor进程管理

#### 7.1 部署Supervisor配置文件

项目中已提供完整的Supervisor配置文件 `scheduler_supervisor.conf`，部署时只需复制：

```bash
# 复制配置文件到Supervisor配置目录
sudo cp scheduler_supervisor.conf /etc/supervisor/conf.d/scheduler.conf

# 重新加载Supervisor配置
sudo supervisorctl reread

# 更新Supervisor配置
sudo supervisorctl update

# 启动应用服务
sudo supervisorctl start scheduler
```

配置文件主要功能：
- 自动启动和重启应用
- 日志管理和轮转
- 进程监控和故障恢复
- 环境变量配置

#### 7.2 启动服务
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start scheduler
```

#### 7.3 常用Supervisor命令
```bash
# 查看服务状态
sudo supervisorctl status

# 重启服务
sudo supervisorctl restart scheduler

# 停止服务
sudo supervisorctl stop scheduler

# 查看日志
sudo supervisorctl tail -f scheduler
```

### 8. SSL证书配置（可选）

#### 8.1 使用Let's Encrypt免费SSL证书
```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your_domain.com
```

### 9. 防火墙配置

#### 9.1 配置UFW防火墙
```bash
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 10. 监控和维护

#### 10.1 查看应用状态
```bash
sudo supervisorctl status scheduler
sudo tail -f /var/log/scheduler/scheduler.log
```

#### 10.2 重启应用
```bash
sudo supervisorctl restart scheduler
```

#### 10.3 更新应用
```bash
cd /var/www/scheduler
git pull  # 如果使用git
source venv/bin/activate
pip install -r requirements.txt
sudo supervisorctl restart scheduler
```

## 常见问题及解决方案

### 1. 数据库连接问题
- 检查数据库服务是否运行
- 验证数据库用户权限
- 确认防火墙设置

### 2. 邮件发送问题
- 检查SMTP服务器配置
- 验证邮箱认证信息
- 确认端口是否被防火墙阻止

### 3. 任务调度问题
- 检查croniter表达式是否正确
- 确认系统时区设置
- 查看应用日志排查错误

### 3. 任务添加失败问题

如果在添加任务时遇到"添加任务失败: 未知错误"，这通常是因为数据库表结构缺少必要的字段。请按以下步骤解决：

1. **检查数据库表结构**
   ```bash
   cd /var/www/scheduler
   sqlite3 scheduler.db "PRAGMA table_info(tasks);"
   ```

2. **使用修复脚本**
   项目中提供了`fix_database.py`脚本，可以自动修复数据库表结构：
   ```bash
   cd /var/www/scheduler
   source venv/bin/activate
   python fix_database.py
   ```

3. **手动修复（如果脚本无法执行）**
   ```bash
   cd /var/www/scheduler
   sqlite3 scheduler.db "ALTER TABLE tasks ADD COLUMN cron_expression TEXT;"
   ```

4. **重启应用服务**
   ```bash
   sudo supervisorctl restart scheduler
   ```

### 4. 性能优化
- 调整Gunicorn worker数量
- 优化数据库查询
- 启用Nginx缓存

## 安全建议

1. 定期更新系统和依赖包
2. 使用强密码和安全的数据库配置
3. 启用SSL/TLS加密
4. 配置防火墙限制不必要的访问
5. 定期备份数据库和配置文件
6. 监控应用日志，及时发现异常

## 备份策略

### 1. 数据库备份
```bash
# MySQL备份
mysqldump -u username -p database_name > backup.sql

# PostgreSQL备份
pg_dump -U username database_name > backup.sql
```

### 2. 应用文件备份
```bash
tar -czf scheduler_backup.tar.gz /var/www/scheduler
```

建议设置定时任务自动执行备份，并将备份文件存储到安全的位置。

## 联系支持

如果在部署过程中遇到问题，请：
1. 检查应用日志文件
2. 查看系统资源使用情况
3. 确认所有配置是否正确
4. 联系技术支持团队